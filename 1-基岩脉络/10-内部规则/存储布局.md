# 存储布局

## 基础存储布局

EVM的账户存储（Account Storage）是一种映射（mapping，键值对存储），每个键和值都是256 bit的数据，它支持256 bit的读和写。这种存储在每个合约账户上都存在，并且是持久的：它的数据会保持在区块链上，直到被明确地修改。

规则1. 默认从存储槽0开始被逐项存储
规则2. 多个值可共享同一个存储槽
规则3. 存储插槽的第一项会以低位对齐（即右对齐）的方式储存
规则4. 结构/数组总是从一个新的存储槽开始，紧跟着它们的变量总是开辟一个新的存储槽

## 映射和动态数组的存储布局

1. 映射

    在基础存储布局规则中，映射只占用32个字节。假设一个映射被存在了槽p，这个槽仅用作占位，不存储任何内容，保持空（0）的状态。而映射中键k对应的值会被存储在由 Keccak 哈希决定的槽中，计算方法为keccak256(h(k) . p)， 其中.是连接符，h是一个函数，根据键的类型应用于键。

        对于值类型（如uint、address、bool等），h函数会将键值填充为32字节。例如，如果键是uint8，则将其扩展为32字节，高位补0。如果键是address，同样扩展为32字节。

        对于字符串或字节，h函数会计算其Keccak256哈希值。

        对于复杂类型，比如结构体或数组，h函数会递归地处理，计算其哈希

2. 动态数组
    与映射类似，动态数组的成员也会被保存在由 Keccak 哈希决定的槽中。在基础存储布局规则中，动态数组只占用32个字节。假设一个动态数组被存在了槽p，这个槽仅用于保存动态数组当前的长度（字节数组和字符串例外）。而数组的元素从keccak256(p)开始保存，排列方式与静态数组的元素相同： 一个元素接着一个元素，如果元素的长度不超过 16 字节，就有可能共享存储槽。

## 字节数组和字符串的存储布局

1. 短字节
对于短字节/字符串（长度<=31字节），字符串的内容和长度会存到同一个槽中，从而节省gas。字符串的内容从最高阶字节开始存，而字节长度的两倍（len * 2）则会存储在最低阶的字节中。

2. 长字节
对于长字节/字符串（长度>31字节），存储方式与动态数组相同，只不过存储槽p存储的不是数组长度，而是字符串长度 * 2 + 1。这样，我们可以通过检查最低位是否为0来区分短字节（为0）和长字节（为1）。
